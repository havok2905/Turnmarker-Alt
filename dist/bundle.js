(()=>{"use strict";const e="turnmarker",t=`module.${e}`;function a(e){return canvas.tokens.ownedTokens.find((t=>t.id==e))}function n(){for(let e of game.users.contents)if(e.role===CONST.USER_ROLES.GAMEMASTER&&e.active)return e.id}function s(e){return(e.turn+1)%e.turns.length}async function r(){let{mode:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=null;switch(e){case 1:t=canvas.scene.getEmbeddedCollection("Tile")?.filter((e=>!0===e.flags?.startMarker))?.map((e=>e.id)),t?.length>0&&await canvas.scene.deleteEmbeddedDocuments("Tile",t);break;case 2:t=canvas.scene.getEmbeddedCollection("Tile")?.filter((e=>!0===e.flags?.turnMarker))?.map((e=>e.id)),t?.length>0&&await canvas.scene.deleteEmbeddedDocuments("Tile",t);break;case 3:t=canvas.scene.getEmbeddedCollection("Tile")?.filter((e=>!0===e.flags?.deckMarker))?.map((e=>e.id)),t?.length>0&&await canvas.scene.deleteEmbeddedDocuments("Tile",t)}}class i{static async deleteTurnMarker(){game.user.isGM?await r({mode:2}):game.socket.emit(t,{mode:2})}static async deleteOnDeckMarker(){game.user.isGM?await r({mode:3}):game.socket.emit(t,{mode:3})}static async placeTurnMarker(e){if(game.user.isGM&&N.getIsEnabled("turnmarker")){const t=a(e);if(void 0!==t){let e=this.getImageDimensions(t,!1,"turnmarker"),a=this.getImageLocation(t,!1,"turnmarker");const n=canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.flags?.turnMarker)),s={img:N.getImagePath(),width:e.w,height:e.h,x:a.x,y:a.y,z:900,rotation:n?n.rotation:0,hidden:t.hidden,locked:!1};return void(void 0===n?await canvas.scene.createEmbeddedDocuments("Tile",[{...s,flags:{turnMarker:!0}}]):await canvas.scene.updateEmbeddedDocuments("Tile",[{...s,_id:n.id}]))}}await this.deleteTurnMarker()}static async placeOnDeckMarker(e){if(game.user.isGM&&N.getIsEnabled("deckmarker")){const t=a(e);if(void 0!==t){let e=this.getImageDimensions(t,!1,"deckmarker"),a=this.getImageLocation(t,!1,"deckmarker"),n=canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.flags?.deckMarker));const s={img:N.getOnDeckImagePath(),width:e.w,height:e.h,x:a.x,y:a.y,z:900,rotation:n?n.rotation:0,hidden:t.hidden,locked:!1};return void(void 0===n?await canvas.scene.createEmbeddedDocuments("Tile",[{...s,flags:{deckMarker:!0}}]):await canvas.scene.updateEmbeddedDocuments("Tile",[{...s,_id:n.id}]))}}await this.deleteOnDeckMarker()}static async deleteStartMarker(){game.user.isGM?await r({mode:1}):game.socket.emit(t,{mode:1})}static async placeStartMarker(e){if(game.user.isGM&&N.getIsEnabled("startmarker")){let t=a(e);if(void 0!==t){let e=this.getImageDimensions(t),a=this.getImageLocation(t),n=canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.flags?.startMarker));const s={img:N.getStartMarker(),width:e.w,height:e.h,x:a.x,y:a.y,z:900,rotation:0,hidden:t.hidden,locked:!1};return void(void 0===n?await canvas.scene.createEmbeddedDocuments("Tile",[{...s,flags:{startMarker:!0}}]):await canvas.scene.updateEmbeddedDocuments("Tile",[{...s,_id:n.id}]))}}await this.deleteStartMarker()}static async moveMarkerToToken(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"turnmarker",s=a(e);if(void 0!==s){let e=this.getImageDimensions(s,!1,n),a=this.getImageLocation(s,!1,n);await canvas.scene.updateEmbeddedDocuments("Tile",[{_id:t,width:e.w,height:e.h,x:a.x,y:a.y,hidden:s.hidden}])}}static async clearAllMarkers(){await this.deleteTurnMarker(),await this.deleteStartMarker(),await this.deleteOnDeckMarker()}static async updateImagePath(){if(game.user.isGM){let e=canvas.scene.tiles.find((e=>1==e.flags?.turnMarker));e&&await e.update({_id:e.id,img:N.getImagePath()})}}static async updateOnDeckImagePath(){if(game.user.isGM){let e=canvas.scene.tiles.find((e=>1==e.flags?.deckMarker));e&&await e.update({_id:e.id,img:N.getOnDeckImagePath()})}}static getImageDimensions(e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"turnmarker",a=arguments.length>1&&void 0!==arguments[1]&&arguments[1]?1:N.getRatio(t),n=0,s=0;switch(canvas.grid.type){case 2:case 3:n=s=e.h*a;break;case 4:case 5:n=s=e.w*a;break;default:n=this.getSmallerDimension(e.w,e.h)*a,s=this.getSmallerDimension(e.w,e.h)*a}return{w:n,h:s}}static getSmallerDimension(e,t){return e<t?e:t}static getImageLocation(e){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"turnmarker",a=arguments.length>1&&void 0!==arguments[1]&&arguments[1]?1:N.getRatio(t),n=0,s=0;switch(canvas.grid.type){case 2:case 3:n=e.center.x-e.h*a/2,s=e.center.y-e.h*a/2;break;case 4:case 5:n=e.center.x-e.w*a/2,s=e.center.y-e.w*a/2;break;default:n=e.center.x-this.getSmallerDimension(e.w,e.h)*a/2,s=e.center.y-this.getSmallerDimension(e.w,e.h)*a/2}return{x:n,y:s}}}class c{static startAnimation(e){if(n()===game.userId)return this.animators||(this.animators={}),e in this.animators?this.animators[e]:(this.animators[e]=new o(e),this.animators)}static stopAnimation(e){n()===game.userId&&(c.startAnimation(e),this.animators&&(this.animators[e].stopAnimation(),delete this.animators[e]))}static stopAllAnimation(){if(n()===game.userId&&this.animators){for(const[,e]of Object.entries(this.animators))e.stopAnimation();this.animators={}}}}class o{constructor(e){const t=1/(12*N.getSpeed())*1e3;this.marker_type=e,this.timeout=setInterval(this.rotateMarker.bind(this),t)}stopAnimation(){clearInterval(this.timeout)}async rotateMarker(){let e;e="deckmarker"===this.marker_type?canvas.scene.tiles.find((e=>1==e.flags?.deckMarker)):canvas.scene.tiles.find((e=>1==e.flags?.turnMarker));try{await e.object.rotate(e.rotation+.5,.001)}catch(e){}}}const m=["mp4","webm","ogg"];class g extends FormApplication{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{})}static get defaultOptions(){return mergeObject(super.defaultOptions,{id:"turnmarker-settings-form",title:"Turn Marker - Global Settings",template:`./modules/${e}/templates/settings.html`,classes:["sheet","tm-settings"],width:500,closeOnSubmit:!0})}getData(){return{turnMarkerEnabled:N.getIsEnabled("turnmarker"),ratio:N.getRatio("turnmarker"),image:this.getSelectList(O,N.getImageIndex("turnmarker")),customImage:N.getCustomImagePath(),previewPath:N.getImagePath(),onDeckMarkerEnabled:N.getIsEnabled("deckmarker"),deckRatio:N.getRatio("deckmarker"),deckImage:this.getSelectList(x,N.getImageIndex("deckmarker")),customDeckImage:N.getCustomDeckImagePath(),onDeckPreviewPath:N.getOnDeckImagePath(),onDeckPlayersOnly:N.getDeckPlayersOnly(),announceActors:this.getSelectList($,N.getAnnounceActors()),announce:N.shouldAnnounceTurns(),announceImage:N.getIncludeAnnounceImage(),announceTokenName:N.getAnnounceTokenName(),announceTurnMarkerAlias:N.getAnnounceTurnMarkerAlias(),announcePlayerNames:N.getAnnouncePlayerNames(),startMarkerEnabled:N.getIsEnabled("startmarker"),startMarkerPath:N.getStartMarkerPath()}}async _updateObject(e,t){console.log("Turn Marker | Saving Settings"),N.setRatio(t.ratio),t.image&&N.setImage("turnmarker",t.image),N.setCustomImagePath(t.customImage),N.setIsEnabled("turnmarker",t.turnMarkerEnabled),N.setShouldAnnounceTurns(t.announce),N.setAnnounceActors(t.announceActors),N.setIncludeAnnounceImage(t.announceImage),N.setAnnounceTokenName(t.announceTokenName),N.setAnnounceTurnMarkerAlias(t.announceTurnMarkerAlias),N.setAnnouncePlayerNames(t.announcePlayerNames),N.setIsEnabled("startmarker",t.startMarkerEnabled),N.setStartMarkerPath(t.startMarkerPath),N.setDeckRatio(t.deckRatio),t.deckImage&&N.setImage("deckmarker",t.deckImage),N.setCustomDeckImagePath(t.customDeckImage),N.setIsEnabled("deckmarker",t.onDeckMarkerEnabled),N.setDeckPlayersOnly(t.onDeckPlayersOnly)}activateListeners(e){super.activateListeners(e);const t=e.find("#image"),a=e.find("#customImage"),n=e.find("#markerImgPreview"),s=e.find("#deckImage"),r=e.find("#customDeckImage"),i=e.find("#onDeckMarkerImgPreview");this.updatePreview(e),t.length>0&&t.on("change",(e=>{""==a[0].value.trim()&&n.attr("src",N.getImageByIndex(Number(e.target.value)))})),s.length>0&&s.on("change",(e=>{""==r[0].value.trim()&&i.attr("src",N.getDeckImageByIndex(Number(e.target.value)))})),a.length>0&&a.on("change",(t=>{this.updatePreview(e)})),r.length>0&&r.on("change",(t=>{this.updatePreview(e)}))}updatePreview(e){this._updateTurnmarkerPreview(e),this._updateOnDeckmarkerPreview(e)}_updateTurnmarkerPreview(e){const t=e.find("#image"),a=e.find("#customImage"),n=e.find("#markerImgPreview"),s=e.find("#markerVideoPreview");if(""==a[0].value.trim())t[0].disabled=!1,n.attr("src",N.getImageByIndex(Number(t[0].value))),n.removeClass("hidden"),s.addClass("hidden");else{t[0].disabled=!0;const e=this.getExtension(a[0].value);m.includes(e.toLowerCase())?(s.attr("src",a[0].value),n.addClass("hidden"),s.removeClass("hidden")):(n.attr("src",a[0].value),n.removeClass("hidden"),s.addClass("hidden"))}}_updateOnDeckmarkerPreview(e){const t=e.find("#deckImage"),a=e.find("#customDeckImage"),n=e.find("#onDeckMarkerImgPreview"),s=e.find("#onDeckMarkerVideoPreview");if(""==a[0].value.trim())t[0].disabled=!1,n.attr("src",N.getDeckImageByIndex(Number(t[0].value))),n.removeClass("hidden"),s.addClass("hidden");else{t[0].disabled=!0;const e=this.getExtension(a[0].value);m.includes(e.toLowerCase())?(s.attr("src",a[0].value),n.addClass("hidden"),s.removeClass("hidden")):(n.attr("src",a[0].value),n.removeClass("hidden"),s.addClass("hidden"))}}getExtension(e){return e.slice(2+(e.lastIndexOf(".")-1>>>0))}getSelectList(e,t){let a=[];return e.forEach(((e,n)=>{a.push({value:e,selected:n==t})})),a}}const d="tm-version",l="speed",u="announce-turn",k="announce-Actors",h="announce-image",f="announce-token",p="announce-turn-marker-alias",b="announce-player-names",y="image",M="customimage",v="ratio",w="turnmarker-enabled",I="animation",A="ondeckmarker-enabled",T="deckimage",D="customdeckimage",P="deckratio",R="deckanimation",E="deckplayersonly",C="startMarker-enabled",S="startMarker-custom",O=["Runes of Incendium by Rin","Runes of the Cultist by Rin","Runes of Regeneration by Rin","Runes of the Cosmos by Rin","Runes of Earthly Dust by Rin","Runes of Reality by Rin","Runes of the Believer by Rin","Runes of the Mad Mage by Rin","Runes of the Blue Sky by Rin","Runes of the Universe by Rin","Runes of Prosperity by Rin"],x=["Runes of Prosperity by Rin","Runes of Incendium by Rin","Runes of the Cultist by Rin","Runes of Regeneration by Rin","Runes of the Cosmos by Rin","Runes of Earthly Dust by Rin","Runes of Reality by Rin","Runes of the Believer by Rin","Runes of the Mad Mage by Rin","Runes of the Blue Sky by Rin","Runes of the Universe by Rin"],$=["Announce for all","Announce for players","Announce for GM-controlled","Announce all but hide GM-controlled names"];class N{static getVersion(){return game.settings.get(e,d)}static setVersion(t){game.settings.set(e,d,t)}static getRatio(t){switch(t){case"turnmarker":return game.settings.get(e,v);case"deckmarker":return game.settings.get(e,P)}}static setRatio(t){game.settings.set(e,v,t)}static setDeckRatio(t){game.settings.set(e,P,t)}static getShouldAnimate(t){switch(t){case"turnmarker":return game.settings.get(e,I);case"deckmarker":return game.settings.get(e,R)}}static getSpeed(){return game.settings.get(e,l)}static shouldAnnounceTurns(){return game.settings.get(e,u)}static setShouldAnnounceTurns(t){game.settings.set(e,u,t)}static getAnnounceActors(){return game.settings.get(e,k)}static setAnnounceActors(t){return game.settings.set(e,k,t)}static getAnnounceTokenName(){return game.settings.get(e,f)}static setAnnounceTokenName(t){return game.settings.set(e,f,t)}static getAnnounceTurnMarkerAlias(){return game.settings.get(e,p)}static setAnnounceTurnMarkerAlias(t){return game.settings.set(e,p,t)}static getAnnouncePlayerNames(){return game.settings.get(e,b)}static setAnnouncePlayerNames(t){return game.settings.set(e,b,t)}static getIncludeAnnounceImage(){return game.settings.get(e,h)}static setIncludeAnnounceImage(t){game.settings.set(e,h,t)}static getImageIndex(t){switch(t){case"turnmarker":return game.settings.get(e,y);case"deckmarker":return game.settings.get(e,T)}}static getStartMarker(){return""==game.settings.get(e,S).trim()?`modules/${e}/assets/start.png`:game.settings.get(e,S)}static getIsEnabled(t){switch(t){case"turnmarker":return game.settings.get(e,w);case"deckmarker":return game.settings.get(e,A);case"startmarker":return game.settings.get(e,C)}}static setIsEnabled(t,a){switch(t){case"turnmarker":game.settings.set(e,w,a);break;case"deckmarker":game.settings.set(e,A,a);break;case"startmarker":game.settings.set(e,C,a)}}static getStartMarkerPath(){return game.settings.get(e,S)}static setStartMarkerPath(t){game.settings.set(e,S,t)}static getImagePath(){return""==game.settings.get(e,M).trim()?this.getImageByIndex(game.settings.get(e,y)):game.settings.get(e,M)}static getOnDeckImagePath(){return""==game.settings.get(e,D).trim()?this.getDeckImageByIndex(game.settings.get(e,T)):game.settings.get(e,D)}static getImageByIndex(t){switch(t){case 0:return`modules/${e}/assets/incendium.png`;case 1:return`modules/${e}/assets/cultist.png`;case 2:return`modules/${e}/assets/regeneration.png`;case 3:return`modules/${e}/assets/cosmos.png`;case 4:return`modules/${e}/assets/earthlydust.png`;case 5:return`modules/${e}/assets/reality.png`;case 6:return`modules/${e}/assets/believer.png`;case 7:return`modules/${e}/assets/madmage.png`;case 8:return`modules/${e}/assets/bluesky.png`;case 9:return`modules/${e}/assets/universe.png`;case 10:return`modules/${e}/assets/prosperity.png`}}static getDeckImageByIndex(t){switch(t){case 0:return`modules/${e}/assets/prosperity.png`;case 1:return`modules/${e}/assets/incendium.png`;case 2:return`modules/${e}/assets/cultist.png`;case 3:return`modules/${e}/assets/regeneration.png`;case 4:return`modules/${e}/assets/cosmos.png`;case 5:return`modules/${e}/assets/earthlydust.png`;case 6:return`modules/${e}/assets/reality.png`;case 7:return`modules/${e}/assets/believer.png`;case 8:return`modules/${e}/assets/madmage.png`;case 9:return`modules/${e}/assets/bluesky.png`;case 10:return`modules/${e}/assets/universe.png`}}static setImage(t,a){switch(t){case"turnmarker":game.settings.set(e,y,a);break;case"deckmarker":game.settings.set(e,T,a)}}static getCustomImagePath(){return game.settings.get(e,M)}static setCustomImagePath(t){game.settings.set(e,M,t)}static getCustomDeckImagePath(){return game.settings.get(e,D)}static setCustomDeckImagePath(t){game.settings.set(e,D,t)}static getDeckPlayersOnly(){return game.settings.get(e,E)}static setDeckPlayersOnly(t){game.settings.set(e,E,t)}static registerSettings(){game.settings.registerMenu(e,"tm.settingsMenu",{name:"tm.settings.button.name",label:"tm.settings.button.label",icon:"fas fa-sync-alt",type:g,restricted:!0}),game.settings.register(e,d,{name:`${e} version`,default:"0.0.0",type:String,scope:"world"}),game.settings.register(e,v,{name:"tm.settings.ratio.name",hint:"tm.settings.ratio.hint",scope:"world",config:!1,type:Number,default:1.5,restricted:!0}),game.settings.register(e,I,{name:"tm.settings.animate.name",hint:"tm.settings.animate.hint",scope:"user",config:!0,type:Boolean,default:!0,onChange:e=>{!game.paused&&e&&canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.flags.turnMarker))?c.startAnimation("turnmarker"):c.stopAnimation("turnmarker")}}),game.settings.register(e,R,{name:"tm.settings.deckAnimate.name",hint:"tm.settings.deckAnimate.hint",scope:"user",config:!0,type:Boolean,default:!0,onChange:e=>{!game.paused&&e&&canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.data.flags.deckMarker))?c.startAnimation("deckmarker"):c.stopAnimation("deckmarker")}}),game.settings.register(e,l,{name:"tm.settings.speed.name",hint:"tm.settings.speed.hint",scope:"user",config:!0,type:Number,default:1}),game.settings.register(e,y,{name:"tm.settings.image.name",scope:"world",config:!1,type:Number,default:0,choices:O,restricted:!0,onChange:e=>i.updateImagePath(e)}),game.settings.register(e,P,{name:"tm.settings.deckRatio.name",hint:"tm.settings.deckRatio.hint",scope:"world",config:!1,type:Number,default:1.5,restricted:!0}),game.settings.register(e,T,{name:"tm.settings.deckImage.name",scope:"world",config:!1,type:Number,default:0,choices:x,restricted:!0,onChange:e=>i.updateOnDeckImagePath(e)}),game.settings.register(e,D,{name:"tm.settings.customDeckImage.name",hint:"tm.settings.customDeckImage.hint",scope:"world",config:!1,type:String,default:"",restricted:!0,onChange:e=>i.updateOnDeckImagePath(e)}),game.settings.register(e,A,{name:"tm.settings.onDeckMarkerEnabled.name",hint:"tm.settings.onDeckMarkerEnabled.hint",scope:"world",config:!1,type:Boolean,default:!1,restricted:!0,onChange:e=>{if(e){if(game.combat&&game.combat.combatant&&game.combat.started){let e=s(game.combat);i.placeOnDeckMarker(game.combat.turns[e].token.id)}}else i.deleteOnDeckMarker()}}),game.settings.register(e,E,{name:"tm.settings.deckPlayersOnly.name",hint:"tm.settings.deckPlayersOnly.hint",scope:"world",config:!1,type:Boolean,default:!0,restricted:!0}),game.settings.register(e,k,{name:"tm.settings.announcedActors.name",hint:"tm.settings.announcedActors.hint",scope:"world",config:!1,type:Number,default:0,restricted:!0,choices:$}),game.settings.register(e,f,{name:"tm.settings.announceTokenName.name",hint:"tm.settings.announceTokenName.hint",scope:"world",config:!1,type:Boolean,default:!1,restricted:!0}),game.settings.register(e,p,{name:"tm.settings.announceTurnMarkerAlias.name",hint:"tm.settings.announceTurnMarkerAlias.hint",scope:"world",config:!1,type:Boolean,default:!1,restricted:!0}),game.settings.register(e,b,{name:"tm.settings.announcePlayerNames.name",hint:"tm.settings.announcePlayerNames.hint",scope:"world",config:!1,type:Boolean,default:!0,restricted:!0}),game.settings.register(e,M,{name:"tm.settings.customImage.name",hint:"tm.settings.customImage.hint",scope:"world",config:!1,type:String,default:"",restricted:!0,onChange:e=>i.updateImagePath(e)}),game.settings.register(e,u,{name:"tm.settings.announce.name",hint:"tm.settings.announce.hint",scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(e,h,{name:"tm.settings.announceImage.name",hint:"tm.settings.announceImage.hint",scope:"world",config:!1,type:Boolean,default:!0}),game.settings.register(e,w,{name:"tm.settings.turnMarkerEnabled.name",hint:"tm.settings.turnMarkerEnabled.hint",scope:"world",config:!1,type:Boolean,default:!0,restricted:!0,onChange:e=>{e?game.combat&&game.combat.combatant&&game.combat.started&&i.placeTurnMarker(game.combat.combatant.token.id):i.deleteTurnMarker()}}),game.settings.register(e,C,{name:"tm.settings.startEnabled.name",hint:"tm.settings.startEnabled.hint",scope:"world",config:!1,type:Boolean,default:!1,restricted:!0,onChange:e=>{e?game.combat&&game.combat.combatant&&game.combat.started&&i.placeStartMarker(game.combat.combatant.token.id):i.deleteStartMarker()}}),game.settings.register(e,S,{name:"tm.settings.startImage.name",hint:"tm.settings.startImage.hint",scope:"world",config:!1,type:String,default:"",restricted:!0})}}class B{static sendTurnMessage(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const a=game.i18n.localize("tm.announceLabel");let n,s,r=e.actor.name,i=r;if(N.getAnnounceTokenName()&&(r=e.token.name,i=e.name),N.getAnnounceTurnMarkerAlias()?(i=a,n=""):n=`<em>${a}</em>`,N.getAnnouncePlayerNames()){let t=[];e.players.forEach((e=>{t.push(e.name)})),0==t.length&&t.push("GM"),s=`<p>${t.join(" - ")}</p>`}else s="";t&&!e.actor.hasPlayerOwner&&(r="???"),ChatMessage.create({speaker:{actor:e.actor,alias:i},content:`<div class="flexrow">${this.placeImage(e)}\n                    <div style="flex: 12;">\n                        <h2>${r}'s Turn</h2>\n                        ${s}\n                    </div>\n                    </div>${n}`})}static placeImage(e){if(N.getIncludeAnnounceImage()){let t=e.img;return e.actor.img&&(t=e.actor.img),`<div style="flex:3;padding-right:4px"><img src="${t}" style="border: none;" /></div>`}return""}}let G="";function L(e){if(e.hidden)return game.user.isGM;if(!canvas.scene.tokenVision)return!0;if(e._controlled)return!0;const t=canvas.scene.tokens.find((e=>e.id===game.combat?.combatant.token.id));if(!t||t.hidden)return game.user.isGM;let a="turnmarker";e.flags.startMarker?a="startmarker":e.flags.deckMarker&&(a="deckmarker");const n=N.getRatio(a),s=e.width/n,r=e.height/n,i=Math.min(s,r)/4;return canvas.effects.visibility.testVisibility(e.center,{tolerance:i,object:e})}async function _(e,t){if(e.combatant&&t&&G!=e.combatant.id&&game.user.isGM&&game.userId==n()&&e&&e.combatant&&e.started&&(G=e.combatant.id,await i.placeStartMarker(e.combatant.token.id),await async function(e){const t=s(e);N.getDeckPlayersOnly()?e.turns[t].actor.hasPlayerOwner?await i.placeOnDeckMarker(e.turns[t].token.id).then((function(){!game.paused&&N.getShouldAnimate("deckmarker")&&c.startAnimation("deckmarker")})):await i.deleteOnDeckMarker():await i.placeOnDeckMarker(e.turns[t].token.id).then((function(){!game.paused&&N.getShouldAnimate("deckmarker")&&c.startAnimation("deckmarker")}))}(e),await i.placeTurnMarker(e.combatant.token.id).then((function(){!game.paused&&N.getShouldAnimate("turnmarker")&&c.startAnimation("turnmarker")})),N.shouldAnnounceTurns()&&!e.combatant.hidden))switch(N.getAnnounceActors()){case 0:B.sendTurnMessage(e.combatant);break;case 1:e.combatant.actor.hasPlayerOwner&&B.sendTurnMessage(e.combatant);break;case 2:e.combatant.actor.hasPlayerOwner||B.sendTurnMessage(e.combatant);break;case 3:B.sendTurnMessage(e.combatant,!0)}}Hooks.once("init",(()=>{N.registerSettings()})),Hooks.once("ready",(async()=>{if(game.user.isGM&&isNewerVersion(game.modules.get(e).version,N.getVersion())&&function(){const t=game.modules.get(e);if(isNewerVersion(t.version,N.getVersion())){class e extends Application{static get defaultOptions(){return mergeObject(super.defaultOptions,{template:`modules/${t.id}/templates/updateWindow.html`,resizable:!1,width:500,height:600,classes:["updateWindow"],title:`${t.title} - Updated`})}getData(){return{version:t.version}}activateListeners(e){super.activateListeners(e),e.find(".show-again").on("change",(e=>{N.setVersion(e.currentTarget.checked?t.version:null)}))}}(new e).render(!0)}}(),game.socket.on(t,(async e=>{game.user.isGM&&e.mode&&r({mode:e.mode})})),game.user.isGM&&(await i.clearAllMarkers(),game.combat&&_(game.combat,!0)),!game.paused){const e=canvas.scene.getEmbeddedCollection("Tile");N.getShouldAnimate("turnmarker")&&e?.find((e=>!0===e.flags?.turnMarker))&&c.startAnimation("turnmarker"),N.getShouldAnimate("deckmarker")&&e?.find((e=>!0===e.flags?.deckMarker))&&c.startAnimation("deckmarker")}})),Hooks.on("updateCombat",(async(e,t)=>{e.started||await i.clearAllMarkers(),"swade"!=game.system.id&&_(e,t)})),Hooks.on("renderCombatTracker",(async(e,t)=>{"swade"==game.system.id&&_(e.viewed,t)})),Hooks.on("deleteCombat",(async()=>{await i.clearAllMarkers(),c.stopAllAnimation()})),Hooks.on("updateToken",(async(e,t,a,r)=>{const c=canvas.scene.getEmbeddedCollection("Tile");let o=c?.find((e=>1==e.flags?.deckMarker));if(o&&(t.x||t.y||t.width||t.height||t.hidden)&&game.combat&&game.user.isGM&&game.userId===n()){const e=s(game.combat),t=game.combat.turns[e].token;await i.moveMarkerToToken(t.id,o.id,"deckmarker")}o=c?.find((e=>1==e.flags?.turnMarker)),o&&(t.x||t.y||t.width||t.height||t.hidden)&&game.combat?.combatant?.token.id===t._id&&game.user.isGM&&game.userId===n()&&await i.moveMarkerToToken(t._id,o.id,"turnmarker")})),Hooks.on("updateTile",(e=>{if(e.flags?.turnMarker||e.flags?.startMarker||e.flags?.deckMarker){const t=canvas.scene.tiles.find((t=>t.id===e.id));t&&(t.renderable=L(t))}})),Hooks.on("sightRefresh",(()=>{for(const e of canvas.scene.tiles)(e.flags?.turnMarker||e.flags?.startMarker||e.flags?.deckMarker)&&(e.renderable=L(e))})),Hooks.on("pauseGame",(e=>{e?c.stopAllAnimation():(N.getShouldAnimate("turnmarker")&&canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.flags?.turnMarker))&&c.startAnimation("turnmarker"),N.getShouldAnimate("deckmarker")&&canvas.scene.getEmbeddedCollection("Tile")?.find((e=>!0===e.flags?.deckMarker))&&c.startAnimation("deckmarker"))}))})();
//# sourceMappingURL=bundle.js.map